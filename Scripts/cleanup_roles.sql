-- =====================================================
-- CLEANUP ROLES SCRIPT FOR OYNA API
-- Скрипт для удаления ролей и связанных данных
-- =====================================================

-- =====================================================
-- 1. УДАЛЕНИЕ СВЯЗЕЙ ПОЛЬЗОВАТЕЛЕЙ И РОЛЕЙ
-- =====================================================

-- Удаляем все связи пользователей с ролями
DELETE FROM user_roles WHERE role_id IN (
    SELECT id FROM roles WHERE name IN ('SuperAdmin', 'Admin', 'Manager', 'User')
);

-- Выводим количество удаленных связей
DO $$
BEGIN
    RAISE NOTICE 'Удалены связи пользователей с ролями';
END
$$;

-- =====================================================
-- 2. УДАЛЕНИЕ РОЛЕЙ ИЗ ТАБЛИЦЫ ROLES
-- =====================================================

-- Удаляем роли по именам
DELETE FROM roles WHERE name IN ('SuperAdmin', 'Admin', 'Manager', 'User');

DO $$
BEGIN
    RAISE NOTICE 'Удалены роли: SuperAdmin, Admin, Manager, User';
END
$$;

-- =====================================================
-- 3. СБРОС АВТОИНКРЕМЕНТА (ОПЦИОНАЛЬНО)
-- =====================================================

-- Если нужно сбросить ID последовательности для ролей
-- Раскомментируйте следующую строку при необходимости:
-- ALTER SEQUENCE roles_id_seq RESTART WITH 1;

-- =====================================================
-- 4. ПРОВЕРКА РЕЗУЛЬТАТА
-- =====================================================

-- Показываем оставшиеся роли
SELECT 'Оставшиеся роли в системе:' AS info;
SELECT id, name, description, is_active, created_at FROM roles ORDER BY id;

-- Показываем количество связей
SELECT 'Текущее количество связей пользователь-роль:' AS info;
SELECT COUNT(*) as user_roles_count FROM user_roles;

-- =====================================================
-- 5. РЕЗУЛЬТАТ ВЫПОЛНЕНИЯ
-- =====================================================

SELECT 'Очистка ролей завершена!' AS status,
       'Роли SuperAdmin, Admin, Manager, User удалены' AS details,
       'Все связи пользователей с этими ролями также удалены' AS note;
